<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }

        .main-layout { display: flex; gap: 20px; }
        .left-panel { width: 320px; }
        .right-panel { flex: 1; }

        .panel {
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px;
        }
        .panel h3 { margin-bottom: 10px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 8px; }

        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        select, input, button {
            width: 100%; padding: 8px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 5px; font-size: 13px;
        }
        button {
            background: #4CAF50; color: white; border: none; cursor: pointer;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .info-box {
            background: #e3f2fd; padding: 10px; border-radius: 5px;
            margin-bottom: 10px; font-size: 12px; line-height: 1.5;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ */
        .room-list { max-height: 200px; overflow-y: auto; }
        .room-item {
            padding: 10px; border: 1px solid #eee; border-radius: 5px;
            margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .room-item:hover { background: #f5f5f5; border-color: #4CAF50; }
        .room-item.active { background: #e8f5e9; border-color: #4CAF50; }
        .room-item .room-info { font-size: 12px; color: #666; }
        .room-item .last-message { font-size: 11px; color: #999; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .room-item .unread-badge {
            background: #f44336; color: white; font-size: 10px;
            padding: 2px 6px; border-radius: 10px; float: right;
        }

        /* ì±„íŒ… íŒ¨ë„ */
        .chat-panel { display: none; }
        .chat-panel.active { display: block; }
        .chat-header {
            background: #4CAF50; color: white; padding: 12px;
            border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;
        }
        .chat-header .room-title { font-weight: bold; }
        .chat-header .unread-info { font-size: 12px; opacity: 0.9; }

        .chat-messages {
            height: 350px; overflow-y: auto; padding: 15px;
            background: #fafafa; border: 1px solid #eee;
        }
        .message {
            margin-bottom: 10px; padding: 10px 15px;
            border-radius: 15px; max-width: 75%; word-wrap: break-word;
        }
        .message.sent {
            background: #4CAF50; color: white;
            margin-left: auto; border-bottom-right-radius: 5px;
        }
        .message.received {
            background: #e0e0e0; color: #333;
            border-bottom-left-radius: 5px;
        }
        .message .sender { font-size: 11px; font-weight: bold; margin-bottom: 3px; }
        .message .time { font-size: 10px; opacity: 0.7; margin-top: 5px; }

        .chat-input {
            display: flex; padding: 10px; background: white;
            border: 1px solid #eee; border-top: none;
            border-radius: 0 0 10px 10px;
        }
        .chat-input input {
            flex: 1; margin-bottom: 0; margin-right: 10px;
            border-radius: 20px;
        }
        .chat-input button { width: auto; padding: 8px 20px; border-radius: 20px; margin-bottom: 0; }

        /* ì•Œë¦¼ */
        .notification {
            position: fixed; top: 20px; right: 20px;
            background: #323232; color: white; padding: 15px 20px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000; animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        .notification .noti-title { font-weight: bold; margin-bottom: 5px; }
        .notification .noti-content { font-size: 13px; opacity: 0.9; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* API í…ŒìŠ¤íŠ¸ ê²°ê³¼ */
        .api-result {
            background: #263238; color: #aed581; padding: 10px;
            border-radius: 5px; font-family: monospace; font-size: 11px;
            max-height: 120px; overflow-y: auto; white-space: pre-wrap;
        }

        .status { text-align: center; padding: 8px; font-size: 12px; border-radius: 5px; margin-bottom: 10px; }
        .status.connected { background: #e8f5e9; color: #4CAF50; }
        .status.disconnected { background: #ffebee; color: #f44336; }

        .btn-group { display: flex; gap: 5px; }
        .btn-group button { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SeolStudy ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

        <div class="main-layout">
            <!-- ì™¼ìª½ íŒ¨ë„ -->
            <div class="left-panel">
                <!-- ì‚¬ìš©ì ì„ íƒ & ë¡œê·¸ì¸ -->
                <div class="panel">
                    <h3>1. ë¡œê·¸ì¸ (WebSocket ì—°ê²°)</h3>
                    <div class="info-box">
                        <strong>í…ŒìŠ¤íŠ¸ ê³„ì •</strong><br>
                        - ë©˜í† : ID 1 (ê¹€ë©˜í† )<br>
                        - ë©˜í‹°1: ID 2 (ì´ë©˜í‹°)<br>
                        - ë©˜í‹°2: ID 3 (ë°•í•™ìƒ)
                    </div>
                    <select id="userSelect">
                        <option value="1" data-role="mentor">ê¹€ë©˜í†  (ë©˜í† , ID: 1)</option>
                        <option value="2" data-role="mentee">ì´ë©˜í‹° (ë©˜í‹°, ID: 2)</option>
                        <option value="3" data-role="mentee">ë°•í•™ìƒ (ë©˜í‹°, ID: 3)</option>
                    </select>
                    <div class="btn-group">
                        <button id="loginBtn" onclick="login()">ë¡œê·¸ì¸</button>
                        <button class="danger" id="logoutBtn" onclick="logout()" disabled>ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                    <div class="status disconnected" id="status">ì—°ê²° ì•ˆë¨</div>
                </div>

                <!-- ì±„íŒ…ë°© ëª©ë¡ -->
                <div class="panel">
                    <h3>2. ë‚´ ì±„íŒ…ë°© ëª©ë¡</h3>
                    <button class="secondary" onclick="loadMyRooms()" id="refreshBtn" disabled>ìƒˆë¡œê³ ì¹¨</button>
                    <div class="room-list" id="roomList">
                        <div style="color: #999; font-size: 12px; text-align: center; padding: 20px;">
                            ë¡œê·¸ì¸ í›„ ì±„íŒ…ë°© ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>

                <!-- ì±„íŒ…ë°© ìƒì„± -->
                <div class="panel">
                    <h3>3. ìƒˆ ì±„íŒ…ë°© ìƒì„±</h3>
                    <label>ë©˜í†  ID</label>
                    <input type="number" id="newMentorId" value="1" placeholder="ë©˜í†  ID">
                    <label>ë©˜í‹° ID</label>
                    <input type="number" id="newMenteeId" value="2" placeholder="ë©˜í‹° ID">
                    <button onclick="createRoom()" id="createRoomBtn" disabled>ì±„íŒ…ë°© ìƒì„±</button>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
            <div class="right-panel">
                <!-- ì±„íŒ… ì˜ì—­ -->
                <div class="panel">
                    <div id="noChatSelected" style="text-align: center; padding: 50px; color: #999;">
                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ’¬</div>
                        ì™¼ìª½ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”<br>
                        <small>(ì…ì¥ ì‹œ ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ë©ë‹ˆë‹¤)</small>
                    </div>

                    <div class="chat-panel" id="chatPanel">
                        <div class="chat-header">
                            <div>
                                <div class="room-title" id="chatTitle">ì±„íŒ…ë°©</div>
                            </div>
                            <button class="danger" onclick="leaveRoom()" style="width:auto; padding: 5px 15px; font-size: 12px;">ë‚˜ê°€ê¸°</button>
                        </div>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="file" id="fileInput" style="display:none" onchange="uploadFile(this)">
                            <button onclick="document.getElementById('fileInput').click()" style="width:auto; padding: 8px 12px; background: #9C27B0;">ğŸ“</button>
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..."
                                   onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()">ì „ì†¡</button>
                        </div>
                        <div id="filePreview" style="display:none; padding: 10px; background: #f0f0f0; border-top: 1px solid #ddd;">
                            <span id="filePreviewName"></span>
                            <button onclick="cancelFileUpload()" style="width:auto; padding: 2px 8px; background: #f44336; font-size: 11px; margin-left: 10px;">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>

                <!-- API í…ŒìŠ¤íŠ¸ -->
                <div class="panel">
                    <h3>API í…ŒìŠ¤íŠ¸</h3>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <button class="secondary" onclick="testGetMessages()">ë©”ì‹œì§€ ì´ë ¥</button>
                        <button class="secondary" onclick="testGetUnreadCount()">ë¯¸í™•ì¸ ìˆ˜</button>
                        <button class="secondary" onclick="testGetRoomInfo()">ì±„íŒ…ë°© ì •ë³´</button>
                    </div>
                    <div class="btn-group" style="margin-bottom: 10px;">
                        <button style="background: #FF9800;" onclick="sendTestPush()">ğŸ”” í…ŒìŠ¤íŠ¸ í‘¸ì‹œ ì „ì†¡</button>
                    </div>
                    <div class="api-result" id="apiResult">API í˜¸ì¶œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        let stompClient = null;
        let currentUserId = null;
        let currentUserRole = null;
        let currentRoomId = null;
        let roomSubscription = null;

        // ===== ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ (WebSocket ì—°ê²°) =====
        async function login() {
            const select = document.getElementById('userSelect');
            currentUserId = parseInt(select.value);
            currentUserRole = select.options[select.selectedIndex].dataset.role;

            // WebSocket ì—°ê²°
            const socket = new SockJS('http://localhost:8080/ws/chat');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, async function(frame) {
                console.log('WebSocket ì—°ê²°ë¨');

                // ê°œì¸ ì•Œë¦¼ ì±„ë„ êµ¬ë…
                stompClient.subscribe('/sub/user/' + currentUserId + '/notification', function(message) {
                    const msg = JSON.parse(message.body);
                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì±„íŒ…ë°©ì´ ì•„ë‹ˆë©´ ì•Œë¦¼ í‘œì‹œ
                    if (msg.roomId !== currentRoomId) {
                        showNotification(msg);
                        loadMyRooms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    }
                });

                // FCM í† í° ë“±ë¡ (í‘¸ì‹œ ì•Œë¦¼ìš©)
                if (messaging) {
                    const fcmToken = await registerFCM();
                    if (fcmToken) {
                        await registerTokenToServer(currentUserId, fcmToken);
                    }
                }

                // UI ì—…ë°ì´íŠ¸
                updateUIAfterLogin(true);
                loadMyRooms();

            }, function(error) {
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
                alert('WebSocket ì—°ê²° ì‹¤íŒ¨!');
            });
        }

        async function logout() {
            // FCM í† í° ì‚­ì œ
            if (currentUserId) {
                await removeTokenFromServer(currentUserId);
            }

            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
            }
            currentUserId = null;
            currentRoomId = null;
            roomSubscription = null;

            updateUIAfterLogin(false);
            document.getElementById('roomList').innerHTML = '<div style="color: #999; font-size: 12px; text-align: center; padding: 20px;">ë¡œê·¸ì¸ í›„ ì±„íŒ…ë°© ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
            leaveRoom();
        }

        function updateUIAfterLogin(isLoggedIn) {
            document.getElementById('userSelect').disabled = isLoggedIn;
            document.getElementById('loginBtn').disabled = isLoggedIn;
            document.getElementById('logoutBtn').disabled = !isLoggedIn;
            document.getElementById('refreshBtn').disabled = !isLoggedIn;
            document.getElementById('createRoomBtn').disabled = !isLoggedIn;
            document.getElementById('status').textContent = isLoggedIn ? `${getUserName(currentUserId)}ë¡œ ì—°ê²°ë¨` : 'ì—°ê²° ì•ˆë¨';
            document.getElementById('status').className = isLoggedIn ? 'status connected' : 'status disconnected';
        }

        // ===== ì±„íŒ…ë°© ëª©ë¡ =====
        function loadMyRooms() {
            if (!currentUserId) return;

            const endpoint = currentUserRole === 'mentor'
                ? `/chat/rooms/mentor/${currentUserId}`
                : `/chat/rooms/mentee/${currentUserId}`;

            fetch(endpoint)
                .then(res => res.json())
                .then(rooms => {
                    const listDiv = document.getElementById('roomList');

                    if (rooms.length === 0) {
                        listDiv.innerHTML = '<div style="color: #999; font-size: 12px; text-align: center; padding: 20px;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                        return;
                    }

                    listDiv.innerHTML = rooms.map(room => {
                        const unread = currentUserRole === 'mentor' ? room.mentorUnreadCount : room.menteeUnreadCount;
                        return `
                            <div class="room-item ${currentRoomId === room.roomId ? 'active' : ''}"
                                 onclick="enterRoom('${room.roomId}')">
                                <div>
                                    <strong>${getPartnerName(room)}</strong>
                                    ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
                                </div>
                                <div class="last-message">${room.lastMessage || 'ìƒˆ ì±„íŒ…ë°©'}</div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => console.error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err));
        }

        function getPartnerName(room) {
            if (currentUserRole === 'mentor') {
                return getUserName(room.menteeId) + ' (ë©˜í‹°)';
            } else {
                return getUserName(room.mentorId) + ' (ë©˜í† )';
            }
        }

        // ===== ì±„íŒ…ë°© ì…ì¥/í‡´ì¥ =====
        function enterRoom(roomId) {
            if (!stompClient) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!');
                return;
            }

            // ì´ì „ ì±„íŒ…ë°© êµ¬ë… í•´ì œ
            if (roomSubscription) {
                roomSubscription.unsubscribe();
            }

            currentRoomId = roomId;

            // ì±„íŒ…ë°© êµ¬ë…
            roomSubscription = stompClient.subscribe('/sub/chat/room/' + roomId, function(message) {
                const msg = JSON.parse(message.body);
                displayMessage(msg);
            });

            // ì„œë²„ì— ì…ì¥ ì•Œë¦¼ (ìë™ ì½ìŒ ì²˜ë¦¬)
            stompClient.send('/pub/chat/enter', {}, JSON.stringify({
                roomId: roomId,
                userId: currentUserId
            }));

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('chatPanel').classList.add('active');
            document.getElementById('chatTitle').textContent = 'ì±„íŒ…ë°©';
            document.getElementById('chatMessages').innerHTML = '';

            // ë©”ì‹œì§€ ì´ë ¥ ë¡œë“œ
            loadMessages();

            // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì½ìŒ ì²˜ë¦¬ ë°˜ì˜)
            setTimeout(() => loadMyRooms(), 500);

            // ì±„íŒ…ë°© ëª©ë¡ active í‘œì‹œ
            document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function leaveRoom() {
            if (roomSubscription) {
                roomSubscription.unsubscribe();
                roomSubscription = null;
            }
            currentRoomId = null;

            document.getElementById('noChatSelected').style.display = 'block';
            document.getElementById('chatPanel').classList.remove('active');
            document.getElementById('chatMessages').innerHTML = '';
            document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
        }

        // ===== ì±„íŒ…ë°© ìƒì„± =====
        function createRoom() {
            const mentorId = document.getElementById('newMentorId').value;
            const menteeId = document.getElementById('newMenteeId').value;

            fetch('/chat/rooms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mentorId: parseInt(mentorId), menteeId: parseInt(menteeId) })
            })
            .then(res => res.json())
            .then(room => {
                showApiResult(JSON.stringify(room, null, 2));
                loadMyRooms();
            })
            .catch(err => showApiResult('Error: ' + err.message));
        }

        // ===== ë©”ì‹œì§€ ì „ì†¡ =====
        let pendingFile = null; // ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ ì •ë³´

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!stompClient || !currentRoomId) return;

            // íŒŒì¼ ë©”ì‹œì§€ ì „ì†¡
            if (pendingFile) {
                stompClient.send('/pub/chat/message', {}, JSON.stringify({
                    roomId: currentRoomId,
                    senderId: currentUserId,
                    messageType: pendingFile.fileType,
                    content: pendingFile.fileName,
                    fileUrl: pendingFile.fileUrl,
                    fileName: pendingFile.fileName
                }));
                cancelFileUpload();
                return;
            }

            // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
            if (!content) return;

            stompClient.send('/pub/chat/message', {}, JSON.stringify({
                roomId: currentRoomId,
                senderId: currentUserId,
                messageType: 'TEXT',
                content: content
            }));

            input.value = '';
        }

        // ===== íŒŒì¼ ì—…ë¡œë“œ =====
        async function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/files/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                pendingFile = data;

                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('filePreviewName').textContent = `ğŸ“ ${data.fileName}`;
                document.getElementById('messageInput').placeholder = 'ì „ì†¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒŒì¼ì„ ë³´ë‚´ì„¸ìš”';

            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            input.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        }

        function cancelFileUpload() {
            pendingFile = null;
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('messageInput').placeholder = 'ë©”ì‹œì§€ ì…ë ¥...';
        }

        // ===== ë©”ì‹œì§€ í‘œì‹œ =====
        function displayMessage(msg) {
            const messagesDiv = document.getElementById('chatMessages');
            const isSent = msg.senderId === currentUserId;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');

            const time = new Date(msg.sentAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit', minute: '2-digit'
            });

            // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ë‚´ìš© ë Œë”ë§
            let contentHtml = '';
            switch (msg.messageType) {
                case 'IMAGE':
                    contentHtml = `
                        <a href="${msg.fileUrl}" target="_blank">
                            <img src="${msg.fileUrl}" alt="${msg.fileName}" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;">
                        </a>
                        <div style="font-size: 11px; margin-top: 5px;">${msg.fileName}</div>
                    `;
                    break;
                case 'VIDEO':
                    contentHtml = `
                        <video src="${msg.fileUrl}" controls style="max-width: 250px; border-radius: 8px;"></video>
                        <div style="font-size: 11px; margin-top: 5px;">${msg.fileName}</div>
                    `;
                    break;
                case 'FILE':
                    contentHtml = `
                        <a href="${msg.fileUrl}" download="${msg.fileName}" style="color: inherit; text-decoration: none;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;">ğŸ“„</span>
                                <div>
                                    <div style="font-weight: bold;">${msg.fileName}</div>
                                    <div style="font-size: 11px; opacity: 0.8;">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</div>
                                </div>
                            </div>
                        </a>
                    `;
                    break;
                default: // TEXT
                    contentHtml = msg.content;
            }

            messageDiv.innerHTML = `
                ${!isSent ? `<div class="sender">${getUserName(msg.senderId)}</div>` : ''}
                ${contentHtml}
                <div class="time">${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function loadMessages() {
            if (!currentRoomId) return;

            fetch(`/chat/messages/${currentRoomId}?page=0&size=50`)
                .then(res => res.json())
                .then(messages => {
                    document.getElementById('chatMessages').innerHTML = '';
                    messages.reverse().forEach(msg => displayMessage(msg));
                })
                .catch(err => console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', err));
        }

        // ===== ì•Œë¦¼ =====
        function showNotification(msg) {
            const container = document.getElementById('notificationContainer');
            const noti = document.createElement('div');
            noti.className = 'notification';
            noti.innerHTML = `
                <div class="noti-title">ğŸ’¬ ${getUserName(msg.senderId)}</div>
                <div class="noti-content">${msg.content}</div>
            `;
            container.appendChild(noti);

            setTimeout(() => noti.remove(), 3000);
        }

        // ===== API í…ŒìŠ¤íŠ¸ =====
        function testGetMessages() {
            if (!currentRoomId) { showApiResult('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
            fetch(`/chat/messages/${currentRoomId}?page=0&size=10`)
                .then(res => res.json())
                .then(data => showApiResult(JSON.stringify(data, null, 2)))
                .catch(err => showApiResult('Error: ' + err.message));
        }

        function testGetUnreadCount() {
            if (!currentRoomId) { showApiResult('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
            fetch(`/chat/messages/${currentRoomId}/unread?userId=${currentUserId}`)
                .then(res => res.json())
                .then(data => showApiResult(`ë¯¸í™•ì¸ ë©”ì‹œì§€ ìˆ˜: ${data}`))
                .catch(err => showApiResult('Error: ' + err.message));
        }

        function testGetRoomInfo() {
            if (!currentRoomId) { showApiResult('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
            fetch(`/chat/rooms/${currentRoomId}`)
                .then(res => res.json())
                .then(data => showApiResult(JSON.stringify(data, null, 2)))
                .catch(err => showApiResult('Error: ' + err.message));
        }

        function showApiResult(text) {
            document.getElementById('apiResult').textContent = text;
        }

        function getUserName(userId) {
            const names = { 1: 'ê¹€ë©˜í† ', 2: 'ì´ë©˜í‹°', 3: 'ë°•í•™ìƒ' };
            return names[userId] || 'ì‚¬ìš©ì' + userId;
        }

        // ===== Firebase Cloud Messaging =====
        let firebaseConfig = null;
        let messaging = null;

        // ì„œë²„ì—ì„œ Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('/notification/firebase-config');
                if (!response.ok) throw new Error('Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨');
                firebaseConfig = await response.json();
                console.log('Firebase ì„¤ì • ë¡œë“œ ì™„ë£Œ');
                return firebaseConfig;
            } catch (error) {
                console.error('Firebase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // Firebase ì´ˆê¸°í™”
        async function initializeFirebase() {
            try {
                // ì„œë²„ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                const config = await loadFirebaseConfig();
                if (!config) {
                    console.error('Firebase ì„¤ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return false;
                }

                // Firebase ì•± ì´ˆê¸°í™”
                firebase.initializeApp({
                    apiKey: config.apiKey,
                    authDomain: config.authDomain,
                    projectId: config.projectId,
                    storageBucket: config.storageBucket,
                    messagingSenderId: config.messagingSenderId,
                    appId: config.appId
                });
                messaging = firebase.messaging();

                // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
                messaging.onMessage((payload) => {
                    console.log('í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);

                    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì±„íŒ…ë°©ì´ ì•„ë‹ˆë©´ ì•Œë¦¼ í‘œì‹œ
                    const roomId = payload.data?.roomId;
                    if (roomId !== currentRoomId) {
                        showBrowserNotification(payload);
                    }
                });

                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // Service Worker ë“±ë¡ ë° FCM í† í° ë°œê¸‰
        async function registerFCM() {
            try {
                // Service Worker ë“±ë¡ (ì„¤ì •ê°’ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬)
                const swUrl = '/firebase-messaging-sw.js';
                const registration = await navigator.serviceWorker.register(swUrl);
                console.log('Service Worker ë“±ë¡ë¨:', registration);

                // Service Workerì— ì„¤ì • ì „ë‹¬
                if (registration.active) {
                    registration.active.postMessage({ type: 'FIREBASE_CONFIG', config: firebaseConfig });
                }
                navigator.serviceWorker.ready.then(reg => {
                    reg.active.postMessage({ type: 'FIREBASE_CONFIG', config: firebaseConfig });
                });

                // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.warn('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return null;
                }

                // FCM í† í° ë°œê¸‰
                const token = await messaging.getToken({
                    vapidKey: firebaseConfig.vapidKey,
                    serviceWorkerRegistration: registration
                });

                console.log('FCM í† í° ë°œê¸‰ë¨:', token);
                return token;
            } catch (error) {
                console.error('FCM ë“±ë¡ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // FCM í† í°ì„ ì„œë²„ì— ë“±ë¡
        async function registerTokenToServer(memberId, token) {
            try {
                const response = await fetch('/notification/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memberId: memberId, token: token })
                });

                if (response.ok) {
                    console.log('FCM í† í° ì„œë²„ ë“±ë¡ ì™„ë£Œ');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('FCM í† í° ì„œë²„ ë“±ë¡ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // FCM í† í°ì„ ì„œë²„ì—ì„œ ì‚­ì œ
        async function removeTokenFromServer(memberId) {
            try {
                await fetch(`/notification/token/${memberId}`, {
                    method: 'DELETE'
                });
                console.log('FCM í† í° ì„œë²„ì—ì„œ ì‚­ì œë¨');
            } catch (error) {
                console.error('FCM í† í° ì‚­ì œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
        function showBrowserNotification(payload) {
            const title = payload.notification?.title || 'ìƒˆ ë©”ì‹œì§€';
            const body = payload.notification?.body || 'ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.';

            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/icon-192x192.png',
                    tag: payload.data?.roomId || 'chat'
                });
            }

            // ì¸ì•± ì•Œë¦¼ë„ í‘œì‹œ
            showNotification({
                senderId: payload.data?.senderId,
                content: body
            });
        }

        // í…ŒìŠ¤íŠ¸ í‘¸ì‹œ ì „ì†¡
        async function sendTestPush() {
            if (!currentUserId) {
                showApiResult('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`/notification/test/${currentUserId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showApiResult('í…ŒìŠ¤íŠ¸ í‘¸ì‹œ ì „ì†¡ ì™„ë£Œ! ì ì‹œ í›„ ì•Œë¦¼ì´ ë„ì°©í•©ë‹ˆë‹¤.');
                } else {
                    showApiResult('í…ŒìŠ¤íŠ¸ í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (error) {
                showApiResult('Error: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
        });
    </script>
</body>
</html>
